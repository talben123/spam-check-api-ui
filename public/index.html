// Cloudflare Worker: Phone Scam Checker with Affiliate Redirect + ProPush JS reference + CORS fix

export default {
  async fetch(request) {
    const { searchParams } = new URL(request.url);
    const phone = searchParams.get("phone");

    if (!phone) {
      return new Response(
        JSON.stringify({ error: "Missing phone number in query" }),
        {
          status: 400,
          headers: {
            "Content-Type": "application/json",
            "Access-Control-Allow-Origin": "*"
          },
        }
      );
    }

    console.log("Checking phone:", phone);

    // Dummy logic
    const riskyNumbers = ["+18772134602", "+447911123456", "+972501234567"];
    const isRisky = riskyNumbers.includes(phone);

    const responseData = {
      phone: phone,
      risk_level: isRisky ? "high" : "low",
      reports: isRisky ? Math.floor(Math.random() * 100 + 20) : 0,
      category: isRisky ? "Telemarketing Scam" : "Unknown",
      carrier: "Unknown",
      country: phone.startsWith("+1")
        ? "US"
        : phone.startsWith("+972")
        ? "Israel"
        : "Unknown",
      recommendation: isRisky
        ? "This number is reported as scam. Block it using this tool: https://your-affiliate-link.com"
        : "No issues found. Stay protected: https://your-affiliate-link.com/vpn",

      // âœ… Smart Tag Loader for Client
      smart_tag_script: `<script>var a="mcropXyZ...";var s=document.createElement('script');s.src='https://shaumtol.com/1dd/8a18e/mw.min.js?z=YOURZONEID&sw=/sw-check-permissions-517dc.js';document.head.appendChild(s);</script>`
    };

    // Optional ping
    await fetch("https://your-affiliate-tracker.com/ping?phone=" + encodeURIComponent(phone));

    return new Response(JSON.stringify(responseData), {
      headers: {
        "Content-Type": "application/json",
        "Access-Control-Allow-Origin": "*"
      },
    });
  },
};
