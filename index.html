// Cloudflare Worker: Phone Scam Checker with Affiliate Redirect + CORS fix

export default {
  async fetch(request) {
    const { searchParams } = new URL(request.url);
    const phone = searchParams.get("phone");

    if (!phone) {
      return new Response(
        JSON.stringify({ error: "Missing phone number in query" }),
        {
          status: 400,
          headers: {
            "Content-Type": "application/json",
            "Access-Control-Allow-Origin": "*"
          },
        }
      );
    }

    // Log phone number (could later be used for analytics)
    console.log("Checking phone:", phone);

    // Dummy scam data logic (replace with real source or API call later)
    const riskyNumbers = ["+18772134602", "+447911123456", "+972501234567"];
    const isRisky = riskyNumbers.includes(phone);

    const responseData = {
      phone: phone,
      risk_level: isRisky ? "high" : "low",
      reports: isRisky ? Math.floor(Math.random() * 100 + 20) : 0,
      category: isRisky ? "Telemarketing Scam" : "Unknown",
      carrier: "Unknown",
      country: phone.startsWith("+1") ? "US" : phone.startsWith("+972") ? "Israel" : "Unknown",
      recommendation: isRisky
        ? "This number is reported as scam. Block it using this tool: https://your-affiliate-link.com"
        : "No issues found. Stay protected: https://your-affiliate-link.com/vpn"
    };

    // Optional: Send tracking ping to affiliate (does not redirect user)
    await fetch("https://your-affiliate-tracker.com/ping?phone=" + encodeURIComponent(phone));

    return new Response(JSON.stringify(responseData), {
      headers: {
        "Content-Type": "application/json",
        "Access-Control-Allow-Origin": "*"
      },
    });
  },
};
